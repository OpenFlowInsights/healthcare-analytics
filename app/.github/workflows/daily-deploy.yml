name: Daily Data Rebuild

# Schedule: Every day at 6 AM UTC (1 AM EST / 10 PM PST)
# This triggers a Vercel production build to refresh static data from Snowflake
on:
  schedule:
    - cron: '0 6 * * *'  # Daily at 6 AM UTC

  # Allow manual trigger from GitHub Actions UI
  workflow_dispatch:
    inputs:
      reason:
        description: 'Reason for manual rebuild'
        required: false
        default: 'Manual trigger'

jobs:
  trigger-vercel-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Trigger Vercel Deploy Hook
        run: |
          echo "Triggering Vercel production build..."
          echo "Reason: ${{ github.event.inputs.reason || 'Scheduled daily rebuild' }}"

          curl -X POST "${{ secrets.VERCEL_DEPLOY_HOOK }}"

          echo "âœ“ Deploy hook triggered successfully"
          echo "View deployment at: https://vercel.com/tim-hudgins-projects/ofi-healthcare/deployments"

      - name: Summary
        run: |
          echo "## Daily Data Rebuild Triggered ðŸš€" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** ${{ github.event.inputs.reason || 'Scheduled daily rebuild' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### What happens next:" >> $GITHUB_STEP_SUMMARY
          echo "1. Vercel starts a new production build" >> $GITHUB_STEP_SUMMARY
          echo "2. Data is fetched from Snowflake at build time" >> $GITHUB_STEP_SUMMARY
          echo "3. Static pages are generated with fresh data" >> $GITHUB_STEP_SUMMARY
          echo "4. Pages are deployed to Vercel's global CDN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Expected build time:** ~2-3 minutes" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "[View Deployment â†’](https://vercel.com/tim-hudgins-projects/ofi-healthcare/deployments)"

# ============================================================================
# SETUP INSTRUCTIONS
# ============================================================================
#
# 1. CREATE VERCEL DEPLOY HOOK:
#    - Go to: https://vercel.com/tim-hudgins-projects/ofi-healthcare/settings/git
#    - Scroll to "Deploy Hooks"
#    - Click "Create Hook"
#    - Name: "Daily Data Rebuild"
#    - Branch: master (or main)
#    - Click "Create Hook"
#    - Copy the webhook URL
#
# 2. ADD GITHUB SECRET:
#    - Go to: https://github.com/YOUR_USERNAME/YOUR_REPO/settings/secrets/actions
#    - Click "New repository secret"
#    - Name: VERCEL_DEPLOY_HOOK
#    - Value: [paste the webhook URL from step 1]
#    - Click "Add secret"
#
# 3. VERIFY:
#    - Go to: https://github.com/YOUR_USERNAME/YOUR_REPO/actions
#    - Click "Daily Data Rebuild" workflow
#    - Click "Run workflow" to test manually
#    - Check Vercel dashboard for new deployment
#
# 4. SNOWFLAKE WAREHOUSE:
#    - Ensure warehouse is configured to auto-resume
#    - Or set it to run continuously during build window (6-6:30 AM UTC)
#    - Warehouse only needs to be active during the ~2 minute build
#
# ============================================================================
# TROUBLESHOOTING
# ============================================================================
#
# If builds fail:
# - Check Vercel environment variables are set (SNOWFLAKE_* vars)
# - Check Snowflake warehouse is running/auto-resume enabled
# - Check GitHub secret VERCEL_DEPLOY_HOOK is correct
# - View build logs: https://vercel.com/tim-hudgins-projects/ofi-healthcare/deployments
#
# To change schedule:
# - Edit the cron expression above
# - Use: https://crontab.guru/ to validate cron syntax
# - Common schedules:
#   - Every 6 hours: '0 */6 * * *'
#   - Twice daily (6 AM & 6 PM UTC): '0 6,18 * * *'
#   - Weekdays only at 6 AM: '0 6 * * 1-5'
#
# ============================================================================
